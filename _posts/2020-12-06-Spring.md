---
layout: post
title: Spring æºç å­¦ä¹ 
date: 2020-11-18
Author: shope
categories: Spring
tags: [Ioc, Aop]
comments: true
---

[^ğŸ‘¦]: Shope write

é…ç½®ç±»ï¼šxmlé…ç½®ã€æ³¨è§£ã€‚

XMLï¼šnew ClassPathXmlApplicationCopntext("xml");

æ³¨è§£ï¼šAnnotationConfigApplicationContext(XXXBean.class)

[TOC]

**BeanDefinition**ï¼šè®¾ç½®Beançš„åŠ è½½æ–¹å¼ï¼Œç”Ÿå‘½å‘¨æœŸç­‰ã€‚

**BeanDefinitionRegistry**ï¼šæ³¨å†Œå®šä¹‰

**BeanFactory** ï¼šè´Ÿè´£ç”Ÿäº§Beanï¼Œä½¿ç”¨ç®€å•å·¥å‚æ–¹æ³•å®ç°ã€‚

## ä¸€ã€Spring IoC å®¹å™¨åŠ è½½è¿‡ç¨‹ï¼ˆé‡ç‚¹ï¼‰

å…³é”®åè¯è§£é‡Šï¼š

**BeanDefinition**ï¼šå°±æ˜¯BeanFactoryç”¨äºç”Ÿäº§Beançš„è®¾è®¡å›¾ï¼Œå®šä¹‰æ¯ä¸ªBeançš„ç‰¹æ€§

**BeanFactoryPostProcessor**ï¼šç”¨äºä¿®æ”¹BeanDefinition

**BeanDefinitionRegisterPostProcessor**ï¼šç”¨äºæ³¨å†ŒBeanDefinition

IoCè¯¦ç»†æµç¨‹ï¼šhttps://www.processon.com/view/link/5f18298a7d9c0835d38a57c0

### 1ã€å®ä¾‹åŒ–ApplicationContext--AnnotationConfigApplicationContext

### 2ã€å®ä¾‹åŒ–BeanFactory--DefaultListableBeanFactoryï¼š

åœ¨**AnnotationConfigApplicationContext**çš„**çˆ¶ç±»æ„é€ å™¨**ä¸­å®ä¾‹åŒ–

![](image_for_notes\DefaultListableBeanFactory_relationship.PNG)

* **DefaultListableBeanFactory**æ˜¯**BeanDefinitionRegistry**çš„å®ç°ç±»
  * **BeanDefinitionRegistry**ï¼šç”¨äºæ³¨å†ŒBeanDefinition(Beanå®šä¹‰)

```java
    public GenericApplicationContext() {
        this.customClassLoader = false;
        this.refreshed = new AtomicBoolean();
        this.beanFactory = new DefaultListableBeanFactory();
    }
```

### 3ã€å®ä¾‹åŒ–BeanDefinitionReader--AnnotatedBeanDefinitionReaderï¼š

åœ¨**AnnotationConfigApplicationContext**æ„é€ å™¨ä¸­å®ä¾‹åŒ–

#### 	3.1å®ä¾‹åŒ–â€œåˆ›ä¸–çºªâ€çš„Bean

â€‹		è¿›å…¥è·¯å¾„ï¼š	**AnnotatedBeanDefinitionReader**æ–‡ä»¶çš„**AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);**

â€‹								ğŸ‘‡

â€‹								**AnnotationConfigUtils**æ–‡ä»¶çš„ **registerAnnotationConfigProcessovrs**

##### 			1> é…ç½®ç±»çš„åç½®å¤„ç†å™¨ï¼šConfigurationClassPostProcessor

##### 			2> internalAutowiredAnnotationProcessorï¼šç”¨äºè§£æ@Configurationã€@ComponentScanã€@ComponentScansä»¥åŠ@Importæ³¨è§£

##### 			3>internalAutowiredAnnotationProcessorï¼šè§£æ@Autowiredã€@Valueæ³¨è§£

##### 			4>internalEventListenerProcessorï¼šSpringäº‹ä»¶çš„ç›‘å¬

```java
public static Set<BeanDefinitionHolder> registerAnnotationConfigProcessors(BeanDefinitionRegistry registry, @Nullable Object source) {
    .....
if (!registry.containsBeanDefinition("org.springframework.context.annotation.internalConfigurationAnnotationProcessor")) {
    		//	å®ä¾‹åŒ–é…ç½®ç±»çš„åç½®å¤„ç†å™¨ConfigurationClassPostProcessor
            def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);
            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, "org.springframework.context.annotation.internalConfigurationAnnotationProcessor"));//è¿™ä¸ªç±»ç”¨äºè§£æé…ç½®ç±»ä¿¡æ¯
        }

        if (!registry.containsBeanDefinition("org.springframework.context.annotation.internalAutowiredAnnotationProcessor")) {
            def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);
            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, "org.springframework.context.annotation.internalAutowiredAnnotationProcessor"));
        }

        if (jsr250Present && !registry.containsBeanDefinition("org.springframework.context.annotation.internalCommonAnnotationProcessor")) {
            def = new RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);
            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, "org.springframework.context.annotation.internalCommonAnnotationProcessor"));
        }

        if (jpaPresent && !registry.containsBeanDefinition("org.springframework.context.annotation.internalPersistenceAnnotationProcessor")) {
            def = new RootBeanDefinition();

            try {
                def.setBeanClass(ClassUtils.forName("org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor", AnnotationConfigUtils.class.getClassLoader()));//	å®ä¾‹åŒ–Beançš„åç½®å¤„ç†å™¨
            } catch (ClassNotFoundException var6) {
                throw new IllegalStateException("Cannot load optional framework class: org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor", var6);
            }

            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, "org.springframework.context.annotation.internalPersistenceAnnotationProcessor"));
        }

        if (!registry.containsBeanDefinition("org.springframework.context.event.internalEventListenerProcessor")) {
            def = new RootBeanDefinition(EventListenerMethodProcessor.class);
            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, "org.springframework.context.event.internalEventListenerProcessor"));
        }

        if (!registry.containsBeanDefinition("org.springframework.context.event.internalEventListenerFactory")) {
            def = new RootBeanDefinition(DefaultEventListenerFactory.class);
            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, "org.springframework.context.event.internalEventListenerFactory"));
        }
    .....
}
```

### 4ã€å®ä¾‹åŒ–BeanDefinitionScanner--ClassPathBeanDefinitionScannerï¼š

**åœ¨AnnotationConfigApplicationContext[æ„é€ å™¨ä¸­]()å®ä¾‹åŒ–**

### 5ã€æ³¨å†Œé…ç½®ç±»ä¸ºBeanDefinitio--AnnotatedGenericBeanDefinition

```java
    public AnnotationConfigApplicationContext(Class<?>... componentClasses) {
        this();
        this.register(componentClasses); //åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ³¨å†Œï¼Œè¿™ä¸ªä¸€ä¸ªé—¨é¢æ–¹æ³•
        this.refresh();
    }
```

### 6ã€è¿›å…¥åˆ°AnnotationConfigApplicationContext(Class<?>... componentClasses)çš„ç¬¬ä¸‰è¡Œä»£ç ï¼šrefresh()

```java
public void refresh() throws BeansException, IllegalStateException {
        synchronized(this.startupShutdownMonitor) {
            //åˆ·æ–°é¢„å¤„ç†ï¼Œä¿å­˜äº†å®¹å™¨çš„å¯åŠ¨æ—¶é—´ï¼Œå¯åŠ¨æ ‡å¿—ç­‰
            this.prepareRefresh();
            ConfigurableListableBeanFactory beanFactory = this.obtainFreshBeanFactory();
            
            this.prepareBeanFactory(beanFactory);
            try {
                this.postProcessBeanFactory(beanFactory);
                this.invokeBeanFactoryPostProcessors(beanFactory);
                this.registerBeanPostProcessors(beanFactory);
                this.initMessageSource();
                this.initApplicationEventMulticaster();
                this.onRefresh();
                this.registerListeners();
                this.finishBeanFactoryInitialization(beanFactory);
                this.finishRefresh();
            } catch (BeansException var9) {
                if (this.logger.isWarnEnabled()) {
         		 .....
                }
                this.destroyBeans();
                this.cancelRefresh(var9);
                throw var9;
            } finally {
                this.resetCommonCaches();
            }
        }
    }
```



```java
    protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {
 		// BeanFactoryPostProcessorå¯ä»¥æ‰‹åŠ¨æ·»åŠ ï¼Œå³ï¼šannotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX);
        PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, this.getBeanFactoryPostProcessors());
        if (beanFactory.getTempClassLoader() == null && beanFactory.containsBean("loadTimeWeaver")) {
            beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));
            beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
        }
    }
```



#### 	å¾ªç¯ä¾èµ–

* Springè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜åªå¯¹äºSingletonæ¨¡å¼ä¸‹çš„ï¼Œå¤šä¾‹æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

â€‹	Aéœ€è¦æ³¨å…¥Bï¼ŒBæœ‰éœ€è¦Açš„æ³¨å…¥ã€‚

```java
class A{
  @Autowird
  class B;
}

class B{
@Autowird
  class A;
}
```

ä¸€çº§ç¼“å­˜ï¼šsingletonObjectï¼ˆConcurrentHashMapï¼‰**å•ä¾‹ç¼“å­˜æ± ** ï¼Œç”¨äºå­˜æ”¾**æˆç†Ÿ**(å·²ç»å®Œæˆèµ‹å€¼)çš„Beanã€‚

äºŒçº§ç¼“å­˜ï¼šearlySingletonObject ï¼ˆHashMapï¼‰ è§£å†³å¾ªç¯ä¾èµ–ï¼Œç”¨äºå­˜**å‚¨çº¯å‡€æ€**(æ²¡æœ‰èµ‹å€¼)çš„Beanã€‚

ä¸‰çº§ç¼“å­˜ï¼šsingletonFactories ï¼ˆHashMapï¼‰AOPï¼Œä»£ç è§£è€¦ã€‚

```java
// ä¸€çº§ç¼“å­˜ ä¹Ÿå« å•ä¾‹æ± 
private final Map<String, Object> singletonObjects = new ConcurrentHashMap<String, Object>(256);
//	ä¸‰çº§ç¼“å­˜
private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<String, ObjectFactory<?>>(16);
// äºŒçº§ç¼“å­˜
private final Map<String, Object> earlySingletonObjects = new HashMap<String, Object>(16);
```

* åˆ¤æ–­æ˜¯å¦ä¸ºå¾ªç¯ä¾èµ–çš„æ ‡å¿—ï¼šäºŒçº§ç¼“å­˜çš„Mapä¸ºnullã€‚

  **é—®é¢˜ï¼šSpringå¦‚ä½•é¿å…è¯»å–åˆ°ä¸å®Œæ•´çš„Bean?**

  éœ€è¦ä½¿ç”¨äºŒçº§ç¼“å­˜ä»¥åŠé”ï¼Œåœ¨å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ°å•ä¾‹æ± ä¸­è·å–å¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡ä¸ºnullä¸”å¯¹è±¡æ­£åœ¨åˆ›å»ºï¼Œä¼šé˜»å¡çº¿ç¨‹ï¼Œç­‰å¾…åˆ°çº¿ç¨‹æ¢å¤åï¼Œå†åˆ°äºŒçº§ç¼“å­˜ä¸­è·å–ï¼Œè·å–åˆ°å€¼å°±è¿”å›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šæ­¤æ—¶çš„å¯¹è±¡æ˜¯çº¯å‡€æ€çš„ï¼Œåœ¨èµ‹å€¼åè¯¥å¯¹è±¡ä¼šè¢«æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ï¼Œå¹¶ç§»é™¤äºŒçº§ç¼“å­˜ä¸­çš„å¯¹è±¡ã€‚åœ¨å¯¹è±¡ä¸ºçº¯å‡€æ€çš„æ—¶å€™è¿”å›çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨å¯¹è±¡èµ‹å€¼åï¼Œè¯¥å¼•ç”¨å°±æ˜¯æˆç†Ÿçš„å¯¹è±¡ã€‚

  ```java
  	// source code åšä¸€ä¸ª double check
      protected Object getSingleton(String beanName, boolean allowEarlyReference) {
          Object singletonObject = this.singletonObjects.get(beanName);
          //	ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼šåˆ¤æ–­å•ä¾‹æ˜¯å¦ä¸ºnull ä¸” å•ä¾‹æ˜¯å¦æ­£åœ¨åˆ›å»º
          if (singletonObject == null && this.isSingletonCurrentlyInCreation(beanName)) {
              //	é”ä½å•ä¾‹æ± å¯¹è±¡
              synchronized(this.singletonObjects) {
                  //	ä» äºŒçº§ç¼“å­˜ ä¸­è·å–å¯¹è±¡
                  singletonObject = this.earlySingletonObjects.get(beanName);
                   //	åšç¬¬äºŒæ¬¡æ£€æŸ¥ï¼Œå†åˆ¤æ–­è·å–çš„å¯¹è±¡æ˜¯å¦ä¸ºnull
                  if (singletonObject == null && allowEarlyReference) {
                      ObjectFactory<?> singletonFactory = (ObjectFactory)this.singletonFactories.get(beanName);
                      if (singletonFactory != null) {
                          //	è¿”å› çº¯å‡€æ€ çš„å¯¹è±¡
                          singletonObject = singletonFactory.getObject
                              //	å°†å¯¹è±¡æ·»åŠ åˆ° äºŒçº§ç¼“å­˜
                          this.earlySingletonObjects.put(beanName, singletonObject);
                          this.singletonFactories.remove(beanName);
                      }
                  }
              }
          }
           return singletonObject;
      }
  ```


åœ¨Springå†…éƒ¨ï¼ŒæŠŠå¸¦ä¸Šäº†**@Configuration**çš„é…ç½®ç±»ç§°ä¹‹ä¸º**Fullé…ç½®ç±»**ï¼ŒæŠŠæ²¡æœ‰å¸¦ä¸Š@Configurationï¼Œä½†æ˜¯å¸¦ä¸Šäº†@Component @ComponentScan @Import @ImportResourceç­‰æ³¨è§£çš„é…ç½®ç±»ç§°ä¹‹ä¸º**Liteé…ç½®ç±»**ã€‚

#### é—®é¢˜ï¼š

##### **BeanFactory:**

æ˜¯ä¸€ä¸ªBeanå·¥å‚ï¼Œæ˜¯Springé¡¶å±‚çš„æ ¸å¿ƒæ¥å£ï¼Œå…¶ä½œç”¨æ˜¯æ ¹æ®BeanDefinitionåˆå§‹åŒ–Beanã€‚

##### **BeanFactoryä¸ApplicationContext:**

BeanFactoryä¸“æ³¨äºç”Ÿäº§Beanï¼Œæœ€å¤§çš„èŒè´£æ˜¯ç”Ÿäº§Beanã€‚ApplicationContextä¼šè·å–Beançš„é…ç½®ï¼Œæ³¨å†ŒBeanDefinitionå®šä¹‰Beanï¼Œå‚æ•°æ³¨å…¥ç­‰ï¼Œæœ€åè°ƒç”¨BeanFactoryçš„getBean()æ–¹æ³•ç”Ÿäº§Beanã€‚

##### **BeanFactoryå’ŒFactoryBeançš„åŒºåˆ«ï¼š**

BeanFactoryç”¨äºç”Ÿäº§Bean,è€ŒFactoryBeanç”¨äºä¿®æ”¹åŸæ¥çš„Beanï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„Bean



### Spring Envent

https://www.processon.com/view/link/5f5075c763768959e2d109df#map

## äºŒã€Spring AOP

1.è¿æ¥ç‚¹ï¼ˆJoin pointï¼‰ï¼šè¿æ¥ç‚¹æ˜¯åœ¨åº”ç”¨æ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ’å…¥åˆ‡é¢ï¼ˆAspectï¼‰çš„ä¸€ä¸ªç‚¹ã€‚è¿™äº›ç‚¹å¯ä»¥æ˜¯è°ƒç”¨æ–¹æ³•æ—¶ã€ç”šè‡³ä¿®æ”¹ä¸€ä¸ªå­—æ®µæ—¶ã€‚

2.åˆ‡ç‚¹ï¼ˆPointcutï¼‰ï¼šåˆ‡ç‚¹æ˜¯æŒ‡é€šçŸ¥ï¼ˆAdviceï¼‰æ‰€è¦ç»‡å…¥ï¼ˆWeavingï¼‰çš„å…·ä½“ä½ç½®ã€‚

ç†è§£ï¼šè¿æ¥ç‚¹æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µï¼Œå¯ä»¥ç†è§£ä¸ºæ‰€æœ‰æ»¡è¶³**åˆ‡ç‚¹**æ‰«ææ¡ä»¶çš„æ‰€æœ‰çš„æ—¶æœºã€‚

#### AOP

* åŸºäºåŠ¨æ€ä»£ç†æ¥å®ç°ï¼Œé»˜è®¤ï¼šå¦‚æœä½¿ç”¨æ¥å£ï¼Œåˆ™ JDK æä¾›åŠ¨æ€ä»£ç†å®ç°ï¼›å¦‚æœæ²¡æœ‰æ¥å£ï¼Œä½¿ç”¨CGLIBå®ç°ï¼›
* Spring AOP ä¾èµ–äº IoC  ã€‚
* Spring AOP åªèƒ½åªèƒ½ä½œç”¨äºSpring å®¹å™¨ä¸­çš„Bean ï¼Œä½¿ç”¨Javaä»£ç å®ç°ï¼Œåªèƒ½ä½œç”¨äºBeanæ–¹æ³•ã€‚

#### AspectJ

æ¥è‡ªäº Eclipse åŸºé‡‘ä¼šï¼Œlinkï¼šhttps://www.eclipse.org/aspectj å±äºé™æ€ç»‡å…¥ï¼Œå®ƒæ˜¯é€šè¿‡ä¿®æ”¹ä»£ç æ¥å®ç°çš„ï¼Œ

å®ƒçš„ç»‡å…¥æ—¶æœºå¯ä»¥æ˜¯ï¼š 

* Compile-time weavingï¼šç¼–è¯‘æœŸç»‡å…¥ï¼Œå¦‚ç±» A ä½¿ç”¨ AspectJ æ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œç±» B å¼• ç”¨äº†å®ƒï¼Œè¿™ä¸ªåœºæ™¯å°±éœ€è¦ç¼–è¯‘æœŸçš„æ—¶å€™å°±è¿›è¡Œç»‡å…¥ï¼Œå¦åˆ™æ²¡æ³•ç¼–è¯‘ç±» Bã€‚ 

- Post-compile weavingï¼šç¼–è¯‘åç»‡å…¥ï¼Œä¹Ÿå°±æ˜¯å·²ç»ç”Ÿæˆäº† .class æ–‡ä»¶ï¼Œæˆ–å·²ç»æ‰“æˆ jar åŒ… äº†ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬éœ€è¦å¢å¼ºå¤„ç†çš„è¯ï¼Œå°±è¦ç”¨åˆ°ç¼–è¯‘åç»‡å…¥ã€‚

* Load-time weavingï¼šæŒ‡çš„æ˜¯åœ¨åŠ è½½ç±»çš„æ—¶å€™è¿›è¡Œç»‡å…¥ï¼Œè¦å®ç°è¿™ä¸ªæ—¶æœŸçš„ç»‡å…¥ï¼Œæœ‰å‡  ç§å¸¸è§çš„æ–¹æ³•ã€‚

  â€‹	1ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å¹²è¿™ä¸ªï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„åŠæ³•ï¼Œåœ¨è¢«ç»‡å…¥ç±»åŠ  è½½åˆ° JVM å‰å»å¯¹å®ƒè¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åŠ è½½çš„æ—¶å€™å®šä¹‰è¡Œä¸ºäº†ã€‚

  â€‹	2ã€åœ¨ JVM å¯åŠ¨çš„æ—¶å€™ æŒ‡å®š AspectJ æä¾›çš„ agentï¼š-javaagent:xxx/xxx/aspectjweaver.jar
  
#### Spring AOP 

  Spring AOP ä¸€å…±æœ‰ä¸‰ç§é…ç½®æ–¹å¼ï¼ŒSpring åšåˆ°äº†å¾ˆå¥½åœ°å‘ä¸‹å…¼å®¹ï¼Œæ‰€ä»¥ç‰ˆæœ¬ç‰ˆæœ¬æ›´æ–°ä¸éœ€è¦æ‹…å¿ƒä»£ç é‡æ„ã€‚ 

  Spring 1.2 åŸºäºæ¥å£çš„é…ç½®ï¼šæœ€æ—©çš„ Spring AOP æ˜¯å®Œå…¨åŸºäºå‡ ä¸ªæ¥å£ï¼ˆMethodBeforeAdviceã€MethodInterceptorï¼‰

```java
//	å®ç°	MethodBeforeAdvice ç±»ä¼¼ å‰ç½®é€šçŸ¥ @Before
public class TulingLogAdvice implements MethodBeforeAdvice {
    @Override
    public void before(Method method, Object[] args, Object target) throws Throwable {
        String methodName = method.getName();
        System.out.println("æ‰§è¡Œç›®æ ‡æ–¹æ³•ã€" + methodName + "ã€‘çš„<å‰ç½®é€šçŸ¥>,å…¥å‚" + Arrays.asList(args));
    }
}

//	å®ç° MethodInterceptor	ç±»ä¼¼ ç¯ç»•ç½®é€šçŸ¥ @Around
public class TulingLogInterceptor implements MethodInterceptor {
    @Override
    public Object invoke(MethodInvocation invocation) throws Throwable {
        System.out.println(getClass()+"è°ƒç”¨æ–¹æ³•å‰");
        Object ret=invocation.proceed();
        System.out.println(getClass()+"è°ƒç”¨æ–¹æ³•å");
        return ret;
    }
}


```

â€‹	Spring 2.0 schema-based é…ç½®ï¼šSpring 2.0 ä»¥åä½¿ç”¨ XML çš„æ–¹å¼æ¥é…ç½®ï¼Œä½¿ç”¨ å‘½åç©ºé—´  

â€‹	Spring 2.0 @AspectJ é…ç½®ï¼šä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®ã€‚

**åŸºäºæ³¨è§£çš„é…ç½®ï¼š**

```java
@Aspect
@Component
public class BuyAspectJ {
    //	è®© com.shope.XXXServiceImpl å®ç° om.shope.UserService æ¥å£
    @DeclareParents(value="com.shope.UserService",defaultImpl=com.shope.XXXServiceImpl.class)
    private XXXService service;
    //	å®šä¹‰åˆ‡ç‚¹
    //	AspectJåˆ‡ç‚¹è¡¨è¾¾å¼ï¼šexection( è¿”å›å€¼ åŒ…å.æ–¹æ³•å(å‚æ•°ç±»å‹) && arg(å‚æ•°å) && bean(ç›®æ ‡å¯¹è±¡))
    @Pointcut("execution(String com.sharpcj.aopdemo.test1.IBuy.buy(double)) && args(price) && bean(girl)")
    public void gif(double price) {
    }
    
    //	å®šä¹‰é€šçŸ¥ç±»å‹ï¼š@Around | @Before | @After | @AfterReturning |  @AfterThrowing
     @Around("gif(price)")
    public String price(ProceedingJoinPoint pj, double price){
      // å£°æ˜äº†ä¸€ä¸ªåˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè¯¥æ–¹æ³• price çš„å†…å®¹å¹¶ä¸é‡è¦ï¼Œæ–¹æ³•åä¹Ÿä¸é‡è¦ï¼Œå®é™…ä¸Šå®ƒåªæ˜¯ä½œä¸ºä¸€ä¸ªæ ‡è¯†ï¼Œä¾›é€šçŸ¥ä½¿ç”¨ã€‚
        return "XXX";
    }
}

```

è´£ä»»é“¾çš„è°ƒç”¨@Aspectçš„ç±»è§£æï¼Œ

è§£æåˆ‡é¢ï¼šå°†æ‰€æœ‰å¸¦æœ‰

advisoré‡Œé¢æœ‰adviseå’ŒpointCutï¼ˆadvise ä¸º @Beforeä¹‹ç±»æ³¨è§£çš„ä»£ç ï¼‰

æœ‰æ¥å£ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼ŒJDKåŠ¨æ€ä»£ç†è°ƒç”¨æ–¹æ³•ä½¿ç”¨åå°„çš„æ–¹å¼ã€‚

æ²¡æœ‰æ¥å£ä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†ï¼ŒCGLIBä½¿ç”¨ASMåˆ›å»ºå­—èŠ‚ç æ–‡ä»¶ï¼Œä½¿ç”¨ç»§æ‰¿å®ç°ã€‚

**JDKçš„åŠ¨æ€ä»£ç†è°ƒç”¨åŠ¨æ€ä»£ç†ç±»ä¸­çš„æ–¹æ³•æ˜¯ä¸ä¼šè§¦å‘ç¬¬äºŒæ¬¡åŠ¨æ€ä»£ç†çš„ã€‚**

**CGLIBåŠ¨æ€ä»£ç†ç§è®¾ç½® @EnableAspectJAutoProxy(exporse = true)ï¼Œå¯ä»¥å®ç°è°ƒç”¨ä»£ç†é…ç½®ç±»ä¸­çš„å…¶ä»–æ–¹æ³•ä¼šè§¦å‘åŠ¨æ€ä»£ç†ã€‚**



## ä¸‰ã€Springå£°æ˜å¼äº‹åŠ¡

------

**@EnableTransactionManagementï¼šå¼€å¯äº‹åŠ¡**

**@EnableAspjectJAutoProxy( exposeProxy = true )** æš´éœ²äº‹åŠ¡

```java
//	åœ¨äº‹åŠ¡Aä¸­è°ƒç”¨äº‹åŠ¡Bï¼Œäº‹åŠ¡ Aã€Béƒ½åœ¨åŒä¸€ä¸ªç±»ä¸­
//	è°ƒç”¨ xxxService çš„ XXXMethodæ–¹æ³•ï¼Œæ‰èƒ½æ­£ç¡®åµŒå¥—ä¸¤ä¸ªäº‹åŠ¡
 ((xxxService)AopContext.currentProxy()).XXXMethod();
```

**@Transactional é…ç½®å±æ€§**

â€‹		**isolation**ï¼šè®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«

â€‹		**propagation**ï¼šäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º

â€‹		**noRollbackFor**ï¼šé‚£äº›å¼‚å¸¸äº‹åŠ¡å¯ä»¥ä¸å›æ»š

â€‹		**noRollbackForClassName**ï¼šå¡«å†™çš„å‚æ•°æ˜¯å…¨ç±»å

â€‹		**rollbackFor**ï¼šå“ªäº›å¼‚å¸¸äº‹åŠ¡éœ€è¦å›æ»š

â€‹		**rollbackForClassName**ï¼šå¡«å†™çš„å‚æ•°æ˜¯å…¨ç±»å

â€‹		**readOnly**ï¼šè®¾ç½®äº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡		

â€‹		**timeout**ï¼šäº‹åŠ¡è¶…å‡ºæŒ‡å®šæ‰§è¡Œæ—¶é•¿åè‡ªåŠ¨ç»ˆæ­¢å¹¶å›æ»š,å•ä½æ˜¯ç§’

@Transactionalå¯ä»¥æ ‡æ³¨åœ¨ç±»ã€æ–¹æ³•ã€çˆ¶ç±»ã€æ¥å£ä¸Šï¼ŒSpringè§£ææœºåˆ¶éƒ½ä¼šå»è§£æåˆ°ã€‚

**1ã€è®¾ç½®éš”ç¦»çº§åˆ«ï¼ˆisolationï¼‰**

ç”¨æ¥è§£å†³å¹¶å‘äº‹åŠ¡æ‰€äº§ç”Ÿä¸€äº›é—®é¢˜ï¼š

å¹¶å‘ï¼š åŒä¸€ä¸ªæ—¶é—´ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œè¯·æ±‚ã€‚

ä»€ä¹ˆæ—¶å€™ä¼šç”Ÿæˆå¹¶å‘é—®é¢˜ï¼šåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€ä¸ªæ•°æ®ï¼ˆå˜é‡ã€å¯¹è±¡ï¼‰è¿›è¡Œè¯»å†™æ“ä½œæ‰ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜

å¹¶å‘ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Ÿ

1.è„è¯»	2.ä¸å¯é‡å¤åº¦	3.å¹»å½±è¯»

**ä½¿ç”¨æƒ…æ™¯ï¼š**

â€‹	1ã€ä¸€ä¸ªäº‹åŠ¡ï¼Œè¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡ä¸­æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œä¼šåœ¨æœ¬äº‹åŠ¡ä¸­äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜

â€‹		è§£å†³æ–¹å¼ï¼š@Transactional(isolation = Isolation.**READ_COMMITTED**)

â€‹	2ã€ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¤šæ¬¡è¯»å–ç›¸åŒçš„æ•°æ®ï¼Œ ä½†æ˜¯è¯»å–çš„ç»“æœä¸ä¸€æ ·ï¼Œ  ä¼šåœ¨æœ¬äº‹åŠ¡ä¸­äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

â€‹		è§£å†³æ–¹å¼ï¼š@Transactional(isolation = Isolation.**REPEATABLE_READ**)

â€‹	3ã€ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¤šæ¬¡å¯¹æ•°æ®è¿›è¡Œæ•´è¡¨æ•°æ®è¯»å–ï¼ˆç»Ÿè®¡ï¼‰ï¼Œä½†æ˜¯ç»“æœä¸ä¸€æ ·ï¼Œ ä¼šåœ¨æœ¬äº‹åŠ¡ä¸­äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

â€‹			è§£å†³æ–¹å¼ï¼š@Transactional(isolation = Isolation.**SERIALIZABLE**)

**éš”ç¦»çº§åˆ«æ¯”è¾ƒ**

â€‹	å¹¶å‘å®‰å…¨ï¼šSERIALIZABLE > REPEATABLE_READ > READ_COMMITTED 

â€‹	è¿è¡Œæ•ˆç‡ï¼šREAD_COMMITTED > REPEATABLE_READ  > SERIALIZABLE              

**2ã€äº‹åŠ¡çš„ä¼ æ’­ç‰¹æ€§**

| **äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç±»å‹** | **å¤–éƒ¨ä¸å­˜åœ¨äº‹åŠ¡** | **å¤–éƒ¨å­˜åœ¨äº‹åŠ¡**                                             | **ä½¿ç”¨æ–¹å¼**                                                 |
| -------------------- | ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| REQUIREDï¼ˆé»˜è®¤ï¼‰     | å¼€å¯æ–°çš„äº‹åŠ¡       | èåˆåˆ°å¤–éƒ¨äº‹åŠ¡ä¸­                                             | @Transactional(propagation = Propagation.REQUIRED)é€‚ç”¨å¢åˆ æ”¹æŸ¥ |
| SUPPORTS             | ä¸å¼€å¯æ–°çš„äº‹åŠ¡     | èåˆåˆ°å¤–éƒ¨äº‹åŠ¡ä¸­                                             | @Transactional(propagation = Propagation.SUPPORTS)é€‚ç”¨æŸ¥è¯¢   |
| REQUIRES_NEW         | å¼€å¯æ–°çš„äº‹åŠ¡       | æŒ‚èµ·å¤–éƒ¨äº‹åŠ¡ï¼Œåˆ›å»ºæ–°çš„äº‹åŠ¡                                   | @Transactional(propagation = Propagation.REQUIRES_NEW)é€‚ç”¨å†…éƒ¨äº‹åŠ¡å’Œå¤–éƒ¨äº‹åŠ¡ä¸å­˜åœ¨ä¸šåŠ¡å…³è”æƒ…å†µï¼Œå¦‚æ—¥å¿— |
| NOT_SUPPORTED        | ä¸å¼€å¯æ–°çš„äº‹åŠ¡     | æŒ‚èµ·å¤–éƒ¨äº‹åŠ¡                                                 | @Transactional(propagation = Propagation.NOT_SUPPORTED)ä¸å¸¸ç”¨ |
| NEVER                | ä¸å¼€å¯æ–°çš„äº‹åŠ¡     | æŠ›å‡ºå¼‚å¸¸                                                     | @Transactional(propagation = Propagation.NEVER )ä¸å¸¸ç”¨       |
| MANDATORY            | æŠ›å‡ºå¼‚å¸¸           | èåˆåˆ°å¤–éƒ¨äº‹åŠ¡ä¸­                                             | @Transactional(propagation = Propagation.MANDATORY)ä¸å¸¸ç”¨    |
| NESTED               | å¼€å¯æ–°çš„äº‹åŠ¡       | èåˆåˆ°å¤–éƒ¨äº‹åŠ¡ä¸­,SavePointæœºåˆ¶ï¼Œå¤–å±‚å½±å“å†…å±‚ï¼Œ å†…å±‚ä¸ä¼šå½±å“å¤–å±‚ | @Transactional(propagation = Propagation.NESTED)ä¸å¸¸ç”¨       |

**3ã€è¶…æ—¶å±æ€§(timeout)**

æŒ‡å®šäº‹åŠ¡ç­‰å¾…çš„æœ€é•¿æ—¶é—´ï¼ˆç§’ï¼‰

å½“å‰äº‹åŠ¡è®¿é—®æ•°æ®æ—¶ï¼Œæœ‰å¯èƒ½è®¿é—®çš„æ•°æ®è¢«åˆ«çš„æ•°æ®è¿›è¡ŒåŠ é”çš„å¤„ç†ï¼Œé‚£ä¹ˆæ­¤æ—¶äº‹åŠ¡å°±å¿…é¡»ç­‰å¾…ï¼Œå¦‚æœç­‰å¾…æ—¶é—´è¿‡é•¿ç»™ç”¨æˆ·é€ æˆçš„ä½“éªŒæ„Ÿå·®ã€‚

**4ã€è®¾ç½®äº‹åŠ¡åªè¯»(readOnly)**

**readonly:**åªä¼šè®¾ç½®åœ¨æŸ¥è¯¢çš„ä¸šåŠ¡æ–¹æ³•ä¸­

â€‹		å¦‚æœä½ ä¸€æ¬¡æ‰§è¡Œå•æ¡æŸ¥è¯¢è¯­å¥ï¼Œåˆ™æ²¡æœ‰å¿…è¦å¯ç”¨äº‹åŠ¡æ”¯æŒï¼Œæ•°æ®åº“é»˜è®¤æ”¯æŒSQLæ‰§è¡ŒæœŸé—´çš„è¯»ä¸€è‡´æ€§ï¼›

â€‹		å¦‚æœä½ ä¸€æ¬¡æ‰§è¡Œå¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œä¾‹å¦‚ç»Ÿè®¡æŸ¥è¯¢ï¼ŒæŠ¥è¡¨æŸ¥è¯¢ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¤šæ¡æŸ¥è¯¢SQLå¿…é¡»ä¿è¯æ•´ä½“çš„è¯»ä¸€è‡´æ€§ï¼Œå¦åˆ™ï¼Œåœ¨å‰æ¡SQLæŸ¥è¯¢ä¹‹åï¼Œåæ¡SQLæŸ¥è¯¢ä¹‹å‰ï¼Œæ•°æ®è¢«å…¶ä»–ç”¨æˆ·æ”¹å˜ï¼Œåˆ™è¯¥æ¬¡æ•´ä½“çš„ç»Ÿè®¡æŸ¥è¯¢å°†ä¼šå‡ºç°è¯»æ•°æ®ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œåº”è¯¥å¯ç”¨äº‹åŠ¡æ”¯æŒï¼ˆå¦‚ï¼šè®¾ç½®ä¸å¯é‡å¤åº¦ã€å¹»å½±è¯»çº§åˆ«ï¼‰ã€‚

â€‹		å¯¹äºåªè¯»äº‹åŠ¡ï¼Œå¯ä»¥æŒ‡å®šäº‹åŠ¡ç±»å‹ä¸ºreadonlyï¼Œå³åªè¯»äº‹åŠ¡ã€‚ç”±äºåªè¯»äº‹åŠ¡ä¸å­˜åœ¨æ•°æ®çš„ä¿®æ”¹ï¼Œå› æ­¤æ•°æ®åº“å°†ä¼šä¸ºåªè¯»äº‹åŠ¡æä¾›ä¸€äº›ä¼˜åŒ–æ‰‹æ®µ 

**5ã€å¼‚å¸¸å±æ€§**

è®¾ç½® å½“å‰äº‹åŠ¡å‡ºç°çš„é‚£äº›å¼‚å¸¸å°±è¿›è¡Œå›æ»šæˆ–è€…æäº¤ã€‚

é»˜è®¤å¯¹äºRuntimeException åŠå…¶å­ç±» é‡‡ç”¨çš„æ˜¯å›æ»šçš„ç­–ç•¥ã€‚

é»˜è®¤å¯¹äºException åŠå…¶å­ç±» é‡‡ç”¨çš„æ˜¯æäº¤çš„ç­–ç•¥ã€‚ 

 **1 >è®¾ç½®å“ªäº›å¼‚å¸¸ä¸å›æ»š(noRollbackFor)** 

  **2>è®¾ç½®å“ªäº›å¼‚å¸¸å›æ»šï¼ˆrollbackFor ï¼‰**

@Transactional(timeout = 3,rollbackFor = {FileNotFoundException.class})

 

**6ã€åœ¨å®æˆ˜ä¸­äº‹åŠ¡çš„ä½¿ç”¨æ–¹å¼**

- å¦‚æœå½“å‰ä¸šåŠ¡æ–¹æ³•æ˜¯ä¸€ç»„ å¢ã€æ”¹ã€åˆ   å¯ä»¥è¿™æ ·è®¾ç½®äº‹åŠ¡

  @Transactional

- å¦‚æœå½“å‰ä¸šåŠ¡æ–¹æ³•æ˜¯ä¸€ç»„ æŸ¥è¯¢  å¯ä»¥è¿™æ ·è®¾ç½®äº‹åŠ¡

  @Transactionl(readOnly=true)

- å¦‚æœå½“å‰ä¸šåŠ¡æ–¹æ³•æ˜¯å•ä¸ª æŸ¥è¯¢  å¯ä»¥è¿™æ ·è®¾ç½®äº‹åŠ¡

  @Transactionl(propagation=propagation.SUPPORTS ,readOnly=true)

**åŸºäºxmlçš„äº‹åŠ¡é…ç½®**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
Â  Â  Â  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
Â  Â  Â  xmlns:context="http://www.springframework.org/schema/context"
Â  Â  Â  xmlns:aop="http://www.springframework.org/schema/aop"
Â  Â  Â  xmlns:tx="http://www.springframework.org/schema/tx"
Â  Â  Â  xsi:schemaLocation="http://www.springframework.org/schema/beans
Â  Â  Â  http://www.springframework.org/schema/beans/spring-beans.xsd
Â  Â  Â  http://www.springframework.org/schema/context
Â  Â  Â  http://www.springframework.org/schema/context/spring-context.xsd
Â  Â  Â  http://www.springframework.org/schema/aop
Â  Â  Â  https://www.springframework.org/schema/aop/spring-aop.xsd
Â  Â  Â  http://www.springframework.org/schema/tx
Â  Â  Â  https://www.springframework.org/schema/tx/spring-tx.xsd">
Â  Â <context:component-scan base-package="cn.tulingxueyuan"></context:component-scan>
Â  Â <context:property-placeholder location="classpath:dbconfig.properties"></context:property-placeholder>
Â  Â <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
Â  Â  Â  Â <property name="username" value="${jdbc.username}"></property>
Â  Â  Â  Â <property name="password" value="${jdbc.password}"></property>
Â  Â  Â  Â <property name="url" value="${jdbc.url}"></property>
Â  Â  Â  Â <property name="driverClassName" value="${jdbc.driverClassName}"></property>
Â  Â </bean>
Â  Â <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
Â  Â  Â  Â <constructor-arg name="dataSource" ref="dataSource"></constructor-arg>
Â  Â </bean>
Â  Â <bean id="namedParameterJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
Â  Â  Â  Â <constructor-arg name="dataSource" ref="dataSource"></constructor-arg>
Â  Â </bean>
Â  Â <!--äº‹åŠ¡æ§åˆ¶-->
Â  Â <!--é…ç½®äº‹åŠ¡ç®¡ç†å™¨çš„bean-->
Â  Â <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
Â  Â  Â  Â <property name="dataSource" ref="dataSource"></property>
Â  Â </bean>
Â  Â <!--
Â  Â åŸºäºxmlé…ç½®çš„äº‹åŠ¡ï¼šä¾èµ–txåç§°ç©ºé—´å’Œaopåç§°ç©ºé—´
Â  Â  Â  Â 1ã€springä¸­æä¾›äº‹åŠ¡ç®¡ç†å™¨ï¼ˆåˆ‡é¢ï¼‰ï¼Œé…ç½®è¿™ä¸ªäº‹åŠ¡ç®¡ç†å™¨
Â  Â  Â  Â 2ã€é…ç½®å‡ºäº‹åŠ¡æ–¹æ³•
Â  Â  Â  Â 3ã€å‘Šè¯‰springå“ªäº›æ–¹æ³•æ˜¯äº‹åŠ¡æ–¹æ³•ï¼ˆäº‹åŠ¡åˆ‡é¢æŒ‰ç…§æˆ‘ä»¬çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å»åˆ‡å…¥äº‹åŠ¡æ–¹æ³•ï¼‰
Â  Â -->
Â  Â <bean id="bookService" class="cn.tulingxueyuan.service.BookService"></bean>
Â  Â <aop:config>
Â  Â  Â  Â <aop:pointcut id="txPoint" expression="execution(* cn.tulingxueyuan.service.*.*(..))"/>
Â  Â  Â  Â <!--äº‹åŠ¡å»ºè®®ï¼šadvice-ref:æŒ‡å‘äº‹åŠ¡ç®¡ç†å™¨çš„é…ç½®-->
Â  Â  Â  Â <aop:advisor advice-ref="myAdvice" pointcut-ref="txPoint"></aop:advisor>
Â  Â </aop:config>
Â  Â <tx:advice id="myAdvice" transaction-manager="transactionManager">
Â  Â  Â  Â <!--äº‹åŠ¡å±æ€§-->
Â  Â  Â  Â <tx:attributes>
Â  Â  Â  Â  Â  Â <!--æŒ‡æ˜å“ªäº›æ–¹æ³•æ˜¯äº‹åŠ¡æ–¹æ³•-->
Â  Â  Â  Â  Â  Â <tx:method name="*"/>
Â  Â  Â  Â  Â  Â <tx:method name="checkout" propagation="REQUIRED"/>
Â  Â  Â  Â  Â  Â <tx:method name="get*" read-only="true"></tx:method>
Â  Â  Â  Â </tx:attributes>
Â  Â </tx:advice>
</beans>
```

æºç è§£æï¼š

AutoProxyRegisterï¼šæ³¨å†ŒBeanPostProcess

ProxyTransactionManagementConfigurationï¼šé…ç½®ç±»

å¯¼å…¥Springå†…ç½®çš„Advisorï¼ˆAdviceï¼Œpointcutï¼‰

åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ–¹æ³•ä¸­ï¼Œå¦‚æœåœ¨æ²¡æœ‰æš´éœ²ï¼Œ**å¤šä¸ªäº‹åŠ¡åµŒå¥—ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“é“¾æ¥**ï¼ŒåµŒå¥—äº‹åŠ¡ä¼šè¢«æ·»åŠ åˆ°**äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨**ä¸­

### æ›´æ–°å¾…ç»­